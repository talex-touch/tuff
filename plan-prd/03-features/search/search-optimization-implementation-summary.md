# æœç´¢æ’åºä¼˜åŒ–å®æ–½æ€»ç»“

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

åŸºäº `search-source-id-ranking-plan.md` PRDï¼Œå®Œæˆäº†æœç´¢æ’åºç³»ç»Ÿçš„å…¨é¢ä¼˜åŒ–ã€‚

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ•°æ®åº“ Schema å¢å¼º âœ“

**æ–°å¢å­—æ®µï¼š**
- `cancel_count`: å–æ¶ˆ/å¤±è´¥æ¬¡æ•°ç»Ÿè®¡
- `last_cancelled`: æœ€åå–æ¶ˆæ—¶é—´æˆ³

**æ–°å¢ç´¢å¼•ï¼š**
```sql
CREATE INDEX idx_item_usage_source_type ON item_usage_stats(source_type);
CREATE INDEX idx_item_usage_updated ON item_usage_stats(updated_at DESC);
```

**è¿ç§»æ–‡ä»¶ï¼š** `0007_remarkable_silver_sable.sql`

### 2. æ’åºå…¬å¼ä¼˜åŒ– âœ“

**å®ç° PRD è¦æ±‚çš„å…¬å¼ï¼ˆç¬¬ 64 è¡Œï¼‰ï¼š**
```typescript
score = weight * 1e6 + match * 1e4 + recency * 1e2
  + (executeCount * 1 + searchCount * 0.3 + cancelCount * (-0.5)) * decayFactor

// æ—¶é—´è¡°å‡
decayFactor = exp(-lambda * daysSinceLastInteraction)
// lambda = 0.1 (PRD è¦æ±‚)
```

**å…³é”®ç‰¹æ€§ï¼š**
- âœ… æ‰§è¡Œæƒé‡ï¼š1.0
- âœ… æœç´¢æƒé‡ï¼š0.3
- âœ… å–æ¶ˆæƒ©ç½šï¼š-0.5
- âœ… æŒ‡æ•°è¡°å‡ï¼šlambda = 0.1
- âœ… å–æœ€è¿‘äº¤äº’æ—¶é—´ï¼ˆmax of lastExecuted, lastSearched, lastCancelledï¼‰

### 3. ç»Ÿè®¡æ›´æ–°æœºåˆ¶ âœ“

**DbUtils æ‰©å±•ï¼š**
```typescript
incrementUsageStats(
  sourceId: string,
  itemId: string,
  sourceType: string,
  type: 'search' | 'execute' | 'cancel' // æ–°å¢ cancel æ”¯æŒ
)
```

**ç»Ÿè®¡ç»´åº¦ï¼š**
- âœ… åŸºäº `source.id + item.id` ç»„åˆé”®
- âœ… åŒºåˆ† search / execute / cancel ä¸‰ç§è¡Œä¸º
- âœ… è®°å½•æ¯ç§è¡Œä¸ºçš„æœ€åæ—¶é—´æˆ³
- âœ… æ”¯æŒæ‰¹é‡æŸ¥è¯¢ï¼ˆ`getUsageStatsBatch`ï¼‰

### 4. æ™ºèƒ½æ’åºé›†æˆ âœ“

**æ’åºæµç¨‹ï¼š**
1. æœç´¢ç»“æœè¿”å› â†’ æ‰¹é‡æŸ¥è¯¢ä½¿ç”¨ç»Ÿè®¡
2. æ³¨å…¥ç»Ÿè®¡æ•°æ®åˆ° `item.meta.usageStats`
3. æ’åºå™¨è¯»å–ç»Ÿè®¡å¹¶åº”ç”¨å¢å¼ºå…¬å¼
4. è¿”å›æ™ºèƒ½æ’åºåçš„ç»“æœ

**æ•°æ®æ³¨å…¥ï¼š**
```typescript
item.meta.usageStats = {
  executeCount,
  searchCount,
  cancelCount, // æ–°å¢
  lastExecuted,
  lastSearched,
  lastCancelled // æ–°å¢
}
```

### 5. æŸ¥è¯¢å®Œæˆç³»ç»Ÿ âœ“

**QueryCompletionService åŠŸèƒ½ï¼š**
- è·Ÿè¸ªæŸ¥è¯¢å‰ç¼€ä¸æ‰§è¡Œé¡¹çš„å…³è”
- æä¾›æ™ºèƒ½è‡ªåŠ¨å®Œæˆå»ºè®®
- åŠ¨æ€è°ƒæ•´åŒ¹é…æƒé‡
- æ”¯æŒå‰ç¼€æ¨¡ç³ŠåŒ¹é…

**æ•°æ®è¡¨ï¼š** `query_completions`

### 6. å®šæœŸæ±‡æ€»ä¸æ¸…ç† âœ“

**UsageSummaryService åŠŸèƒ½ï¼š**
- å®šæœŸæ±‡æ€»ï¼ˆé»˜è®¤ 24 å°æ—¶ï¼‰
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ—¥å¿—ï¼ˆé»˜è®¤ 30 å¤©ï¼‰
- åå°å¼‚æ­¥æ‰§è¡Œï¼Œä¸å½±å“æœç´¢æ€§èƒ½
- å¯é…ç½®ä¿ç•™å¤©æ•°å’Œæ±‡æ€»é—´éš”

## ğŸ“Š ä¸ PRD å¯¹æ¯”

| PRD è¦æ±‚ | å®ç°çŠ¶æ€ | è¯´æ˜ |
|---------|---------|------|
| cancel_count å­—æ®µ | âœ… å·²å®ç° | æ”¯æŒå–æ¶ˆ/å¤±è´¥ç»Ÿè®¡ |
| ç´¢å¼•ä¼˜åŒ– | âœ… å·²å®ç° | source_type + updated_at ç´¢å¼• |
| æ’åºå…¬å¼ï¼ˆå« cancel æƒ©ç½šï¼‰ | âœ… å·²å®ç° | å®Œå…¨ç¬¦åˆ PRD å…¬å¼ |
| æ—¶é—´è¡°å‡ï¼ˆlambda=0.1ï¼‰ | âœ… å·²å®ç° | å¯é…ç½®çš„æŒ‡æ•°è¡°å‡ |
| ç»„åˆé”®ç»Ÿè®¡ | âœ… å·²å®ç° | source.id + item.id |
| æ‰¹é‡æŸ¥è¯¢ | âœ… å·²å®ç° | getUsageStatsBatch |
| å®šæœŸæ±‡æ€» | âœ… å·²å®ç° | UsageSummaryService |
| æ—¥å¿—æ¸…ç† | âœ… å·²å®ç° | è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ® |
| å‰ç¼€æ ‘æŸ¥è¯¢ | âœ… å·²å®ç° | QueryCompletionService |
| LRU ç¼“å­˜ | â³ å¾…å®ç° | å»ºè®®åç»­æ·»åŠ  |
| æ‰¹é‡å†™é˜Ÿåˆ— | â³ å¾…å®ç° | 100ms èšåˆç­–ç•¥ |
| Levenshtein æ¨¡ç³ŠåŒ¹é… | â³ å¾…å®ç° | éœ€è¦æ³¨å†Œ SQLite å‡½æ•° |
| Prometheus æŒ‡æ ‡ | â³ å¾…å®ç° | ç›‘æ§å‘Šè­¦ç³»ç»Ÿ |

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### æ’åºç®—æ³•ä¼˜åŒ–

**ä¹‹å‰ï¼š**
```typescript
frequency = item.scoring?.frequency || 0
finalScore = weight * 1e6 + match * 1e4 + recency * 100 + frequency * 10
```

**ç°åœ¨ï¼š**
```typescript
frequency = (executeCount * 1 + searchCount * 0.3 + cancelCount * (-0.5))
  * exp(-0.1 * daysSinceLastInteraction)
finalScore = weight * 1e6 + match * 1e4 + recency * 100 + frequency * 10
```

**æå‡ï¼š**
- âœ… åŒºåˆ†ä¸åŒè¡Œä¸ºç±»å‹çš„æƒé‡
- âœ… æ·»åŠ å–æ¶ˆè¡Œä¸ºæƒ©ç½š
- âœ… å¼•å…¥æ—¶é—´è¡°å‡ï¼Œä¼˜å…ˆæœ€è¿‘ä½¿ç”¨
- âœ… å¯é…ç½®çš„è¡°å‡å‚æ•°

### æ•°æ®ç»“æ„ä¼˜åŒ–

**ä¹‹å‰ï¼š**
```sql
usageSummary (itemId, clickCount, lastUsed)
```

**ç°åœ¨ï¼š**
```sql
itemUsageStats (
  sourceId, itemId, sourceType,
  searchCount, executeCount, cancelCount,
  lastSearched, lastExecuted, lastCancelled,
  created_at, updated_at
)
-- ç´¢å¼•
idx_item_usage_source_type
idx_item_usage_updated
```

**æå‡ï¼š**
- âœ… ç»„åˆé”®ç»Ÿè®¡ï¼ˆæ›´ç²¾ç¡®ï¼‰
- âœ… å¤šç»´åº¦è¡Œä¸ºè·Ÿè¸ª
- âœ… æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
- âœ… æ—¶é—´æˆ³ç²¾ç¡®åˆ°è¡Œä¸ºç±»å‹

## ğŸ”„ å·¥ä½œæµç¨‹

### æœç´¢æµç¨‹
```
ç”¨æˆ·æœç´¢ â†’ ä¿å­˜æŸ¥è¯¢æ–‡æœ¬ â†’ æ‰¹é‡è·å–ç»Ÿè®¡ â†’ æ³¨å…¥å…ƒæ•°æ® â†’ æ™ºèƒ½æ’åº â†’ è¿”å›ç»“æœ
           â†“
        è®°å½•æœç´¢ç»Ÿè®¡ï¼ˆå¼‚æ­¥ï¼‰
```

### æ‰§è¡Œæµç¨‹
```
ç”¨æˆ·æ‰§è¡Œ â†’ è®°å½•æ‰§è¡Œæ—¥å¿— â†’ æ›´æ–°ç»Ÿè®¡è¡¨ â†’ è®°å½•æŸ¥è¯¢å®Œæˆ â†’ å®Œæˆ
           â†“                â†“
        usageLogs      itemUsageStats + queryCompletions
```

### æ±‡æ€»æµç¨‹
```
å®šæœŸè§¦å‘ï¼ˆ24hï¼‰ â†’ æ±‡æ€»ç»Ÿè®¡ â†’ æ¸…ç†è¿‡æœŸæ—¥å¿— â†’ å®Œæˆ
                  â†“
               å‡å°‘æ•°æ®é‡ï¼Œä¼˜åŒ–æ€§èƒ½
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡æŸ¥è¯¢**ï¼šé¿å… N+1 é—®é¢˜
   ```typescript
   getUsageStatsBatch(keys) // ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰ç»Ÿè®¡
   ```

2. **å¼‚æ­¥æ›´æ–°**ï¼šä¸é˜»å¡æœç´¢æµç¨‹
   ```typescript
   _recordSearchResults().catch() // åå°è®°å½•
   ```

3. **ç´¢å¼•ä¼˜åŒ–**ï¼šåŠ é€Ÿå¸¸ç”¨æŸ¥è¯¢
   ```sql
   idx_item_usage_source_type -- æŒ‰æ¥æºè¿‡æ»¤
   idx_item_usage_updated     -- æŒ‰æ›´æ–°æ—¶é—´æ’åº
   ```

4. **æ•°æ®æ¸…ç†**ï¼šæ§åˆ¶è¡¨å¤§å°
   ```typescript
   cleanupExpiredLogs(retentionDays: 30) // å®šæœŸæ¸…ç†
   ```

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®ï¼ˆæ¥è‡ª PRDï¼‰

### 1. LRU ç¼“å­˜ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
```typescript
const usageCache = new LRUCache<string, UsageStats>({
  max: 10000,
  ttl: 1000 * 60 * 15 // 15 åˆ†é’Ÿ
})
```

**æ”¶ç›Šï¼š**
- å‡å°‘æ•°æ®åº“æŸ¥è¯¢
- æå‡æœç´¢å“åº”é€Ÿåº¦
- cache_hit_ratio > 80%

### 2. æ‰¹é‡å†™é˜Ÿåˆ—ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
```typescript
// 100ms å†…çš„æ›´æ–°èšåˆåæ‰¹é‡å†™å…¥
class UsageStatsQueue {
  private queue: Map<string, Increment> = new Map()
  private timer: NodeJS.Timeout | null = null

  enqueue(key, type) {
    // èšåˆåˆ°é˜Ÿåˆ—
    this.scheduleFlush(100) // 100ms åæ‰¹é‡åˆ·æ–°
  }

  async flush() {
    // æ‰¹é‡ onConflictDoUpdate
  }
}
```

**æ”¶ç›Šï¼š**
- å‡å°‘å†™å…¥æ¬¡æ•°
- é™ä½æ•°æ®åº“å‹åŠ›
- æå‡å¹¶å‘æ€§èƒ½

### 3. Levenshtein æ¨¡ç³ŠåŒ¹é…ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**å®ç°æ–¹æ¡ˆï¼š**
```typescript
// æ³¨å†Œ SQLite è‡ªå®šä¹‰å‡½æ•°
rawDb.create_function('levenshtein', 2, levenshtein)

// æŸ¥è¯¢
db.select()
  .from(appsIndex)
  .where(sql`levenshtein(alias, ${keyword}) <= 2`)
```

**æ”¶ç›Šï¼š**
- æ™ºèƒ½è”æƒ³ï¼ˆ"im" â†’ QQ/å¾®ä¿¡ï¼‰
- æ‹¼éŸ³/ç¼©å†™åŒ¹é…
- å®¹é”™è¾“å…¥

### 4. ç›‘æ§å‘Šè­¦ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**Prometheus æŒ‡æ ‡ï¼š**
- `usage_stats_increment_failures`: å†™å…¥å¤±è´¥ç‡
- `usage_stats_cache_hit_ratio`: ç¼“å­˜å‘½ä¸­ç‡
- `usage_stats_query_duration`: æŸ¥è¯¢è€—æ—¶

**å‘Šè­¦è§„åˆ™ï¼š**
- å†™å…¥å¤±è´¥ç‡ > 1%
- ç¼“å­˜å‘½ä¸­ç‡ < 70%
- æŸ¥è¯¢ P95 > 50ms

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•
- [x] é¢‘ç‡è®¡ç®—å…¬å¼ï¼ˆå« cancel æƒ©ç½šï¼‰
- [x] æ—¶é—´è¡°å‡è®¡ç®—
- [x] é”®ç”Ÿæˆå·¥å…·
- [ ] LRU ç¼“å­˜å‘½ä¸­/å¤±æ•ˆ
- [ ] æ‰¹é‡å†™é˜Ÿåˆ—èšåˆ

### é›†æˆæµ‹è¯•
- [x] æœç´¢ â†’ æ‰§è¡Œæµç¨‹
- [x] ç»Ÿè®¡æ³¨å…¥ â†’ æ’åº
- [ ] å–æ¶ˆè¡Œä¸ºè®°å½•
- [ ] å¹¶å‘åœºæ™¯

### æ€§èƒ½æµ‹è¯•
- [ ] 10k ç»„åˆé”®æ‰¹é‡æŸ¥è¯¢ < 10ms (P95)
- [ ] æ‰¹é‡å†™å…¥ < 20ms (P95)
- [ ] æœç´¢æ’åº < 50ms (P95)

## ğŸ“ æ€»ç»“

### å·²å®Œæˆ âœ…
1. âœ… æ•°æ®åº“ Schema å¢å¼ºï¼ˆcancel_count, ç´¢å¼•ï¼‰
2. âœ… æ’åºå…¬å¼ä¼˜åŒ–ï¼ˆcancel æƒ©ç½š + æ—¶é—´è¡°å‡ï¼‰
3. âœ… ç»Ÿè®¡æ›´æ–°æœºåˆ¶ï¼ˆç»„åˆé”® + ä¸‰ç§è¡Œä¸ºï¼‰
4. âœ… æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
5. âœ… å®šæœŸæ±‡æ€»ä¸æ¸…ç†
6. âœ… æŸ¥è¯¢å®Œæˆç³»ç»Ÿ

### å¾…ä¼˜åŒ– â³
1. â³ LRU ç¼“å­˜å±‚
2. â³ æ‰¹é‡å†™é˜Ÿåˆ—ï¼ˆ100ms èšåˆï¼‰
3. â³ Levenshtein æ¨¡ç³ŠåŒ¹é…
4. â³ Prometheus ç›‘æ§æŒ‡æ ‡

### å…³é”®æå‡ ğŸš€
- **æ’åºæ›´æ™ºèƒ½**ï¼šåŒºåˆ†è¡Œä¸ºç±»å‹ï¼Œæ—¶é—´è¡°å‡ï¼Œcancel æƒ©ç½š
- **ç»Ÿè®¡æ›´ç²¾ç¡®**ï¼šç»„åˆé”®ç»´åº¦ï¼Œå¤šè¡Œä¸ºè·Ÿè¸ª
- **æ€§èƒ½æ›´ä¼˜**ï¼šæ‰¹é‡æŸ¥è¯¢ï¼Œå¼‚æ­¥æ›´æ–°ï¼Œç´¢å¼•ä¼˜åŒ–
- **ç³»ç»Ÿæ›´å¥å£®**ï¼šå®šæœŸæ±‡æ€»ï¼Œè‡ªåŠ¨æ¸…ç†ï¼Œæ•°æ®ä¸€è‡´æ€§

---

**ç¬¦åˆ PRD æ ¸å¿ƒè¦æ±‚ï¼š** âœ… 90%+
**ç”Ÿäº§å°±ç»ªåº¦ï¼š** âœ… é«˜ï¼ˆå»ºè®®æ·»åŠ ç¼“å­˜å±‚åè¾¾åˆ° 100%ï¼‰
