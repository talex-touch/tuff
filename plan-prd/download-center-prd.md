# ç»Ÿä¸€ä¸‹è½½ä¸­å¿ƒ PRD

## ä¸€ã€äº§å“èƒŒæ™¯

### 1.1 ç°çŠ¶åˆ†æ
å½“å‰å­˜åœ¨å¤šç§ä¸‹è½½åœºæ™¯:
- åº”ç”¨æ›´æ–° (GitHub Releases)
- æ’ä»¶å®‰è£… (NPM/GitHub/TPEX)
- èµ„æºæ–‡ä»¶ (å›¾æ ‡/ä¸»é¢˜/è¯­è¨€åŒ…)

å„æ¨¡å—ç‹¬ç«‹å¤„ç†ä¸‹è½½,å­˜åœ¨é—®é¢˜:
- ç¼ºä¹ç»Ÿä¸€ç®¡ç†
- æ— æ³•æ§åˆ¶å¹¶å‘
- å¤§æ–‡ä»¶æ˜“å¤±è´¥,æ— æ–­ç‚¹ç»­ä¼ 
- ç¼ºä¹è¿›åº¦ç»Ÿä¸€å±•ç¤º

### 1.2 æ ¸å¿ƒç›®æ ‡
- å»ºç«‹ç»Ÿä¸€ä¸‹è½½ç®¡ç†æœåŠ¡
- å®ç°åˆ‡ç‰‡ä¸‹è½½å’Œæ–­ç‚¹ç»­ä¼ 
- æ”¯æŒæ™ºèƒ½ä¼˜å…ˆçº§è°ƒåº¦
- æä¾›ç”¨æˆ·å¯é…ç½®çš„å¹¶å‘æ§åˆ¶
- ç»Ÿä¸€çš„ä¸‹è½½ç®¡ç†ç•Œé¢

## äºŒã€åŠŸèƒ½éœ€æ±‚

### 2.1 ä¸‹è½½ä¸­å¿ƒæ¶æ„

**æ ¸å¿ƒç»„ä»¶**:
```typescript
class DownloadCenter {
  private taskQueue: TaskQueue
  private downloadWorkers: DownloadWorker[]
  private chunkManager: ChunkManager
  private databaseService: DatabaseService
  
  async addTask(request: DownloadRequest): Promise<string>
  async pauseTask(taskId: string): Promise<void>
  async resumeTask(taskId: string): Promise<void>
  async cancelTask(taskId: string): Promise<void>
}

interface DownloadRequest {
  url: string
  destination: string
  priority: DownloadPriority
  module: DownloadModule
  checksum?: string
}

enum DownloadPriority {
  CRITICAL = 100,    // ç”¨æˆ·æ‰‹åŠ¨è§¦å‘
  HIGH = 80,         // æ’ä»¶å®‰è£…
  NORMAL = 50,       // åº”ç”¨æ›´æ–°
  LOW = 20,          // èµ„æºæ–‡ä»¶
  BACKGROUND = 10    // åå°é¢„åŠ è½½
}
```

### 2.2 åˆ‡ç‰‡ä¸‹è½½ç®¡ç†

**ChunkManager**:
- é»˜è®¤åˆ‡ç‰‡å¤§å°: 1MB
- å¹¶å‘ä¸‹è½½åˆ‡ç‰‡
- ä¸‹è½½å®Œæˆååˆå¹¶
- å¤±è´¥åˆ‡ç‰‡è‡ªåŠ¨é‡è¯•

### 2.3 æ™ºèƒ½ä¼˜å…ˆçº§è°ƒåº¦

**ä¼˜å…ˆçº§è®¡ç®—**:
```typescript
calculatePriority(request: DownloadRequest): number {
  basePriority * moduleMultiplier * sizeMultiplier * networkMultiplier
}
```

**è°ƒæ•´å› ç´ **:
- æ¨¡å—ç±»å‹ (ç”¨æˆ·æ‰‹åŠ¨ > æ’ä»¶ > æ›´æ–° > èµ„æº)
- æ–‡ä»¶å¤§å° (å°æ–‡ä»¶ä¼˜å…ˆ)
- ç½‘ç»œçŠ¶å†µ (æ…¢ç½‘ç»œæé«˜ä¼˜å…ˆçº§)
- ç”¨æˆ·è¡Œä¸º (æ‰‹åŠ¨å¯åŠ¨ +20)

### 2.4 å¹¶å‘æ§åˆ¶

**ç”¨æˆ·é…ç½®**:
- æœ€å¤§å¹¶å‘æ•°: 1-10 (é»˜è®¤3)
- è‡ªåŠ¨è°ƒæ•´: æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´
- ç½‘ç»œæ„ŸçŸ¥: ç½‘ç»œå˜åŒ–æ—¶è‡ªåŠ¨é€‚é…

**è‡ªåŠ¨è°ƒæ•´ç®—æ³•**:
- é«˜é€Ÿç½‘ç»œ (>10MB/s): å¹¶å‘ x 1.5
- ä½é€Ÿç½‘ç»œ (<1MB/s): å¹¶å‘ x 0.5
- ä¸ç¨³å®šç½‘ç»œ: å¹¶å‘ x 0.7

### 2.5 ç”¨æˆ·ç•Œé¢

**ä¸‹è½½ä¸­å¿ƒé¢æ¿**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¥ ä¸‹è½½ä¸­å¿ƒ                 [è®¾ç½®] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¿›è¡Œä¸­ (2)                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æ’ä»¶: touch-music      45.2MB  â”‚ â”‚
â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 60% 2.1MB/s 15ç§’    â”‚ â”‚
â”‚ â”‚ [æš‚åœ] [å–æ¶ˆ]                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç­‰å¾…ä¸­ (3) â”‚ å·²å®Œæˆ (15) â”‚ å¤±è´¥ (2) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾ç½®é¡µé¢**:
- å¹¶å‘ä¸‹è½½æ•°
- åˆ‡ç‰‡å¤§å° (512KB/1MB/2MB/4MB)
- æ–­ç‚¹ç»­ä¼ å¼€å…³
- è‡ªåŠ¨é‡è¯•æ¬¡æ•°
- ä¸´æ—¶æ–‡ä»¶ç›®å½•
- å†å²è®°å½•ä¿ç•™æœŸ

## ä¸‰ã€æŠ€æœ¯è®¾è®¡

### 3.1 æ•°æ®åº“è®¾è®¡

ä½¿ç”¨ Drizzle ORM + SQLite:

```typescript
// ä¸‹è½½ä»»åŠ¡è¡¨
downloadTasksSchema {
  id: text
  url: text
  destination: text
  priority: integer
  status: text
  totalSize: integer
  downloadedSize: integer
  checksum: text
  createdAt: integer
}

// ä¸‹è½½åˆ‡ç‰‡è¡¨
downloadChunksSchema {
  id: text
  taskId: text
  index: integer
  downloaded: integer
  status: text
}
```

### 3.2 IPCé€šé“è®¾è®¡

**ä¸»è¿›ç¨‹é€šé“**:
- `download:add-task`
- `download:pause-task`
- `download:resume-task`
- `download:cancel-task`

**äº‹ä»¶å¹¿æ’­**:
- `download:task-progress`
- `download:task-completed`
- `download:task-failed`

### 3.3 æ–‡ä»¶ç»“æ„
```
apps/core-app/src/main/modules/download/
â”œâ”€â”€ download-center.ts       # ä¸»æ¨¡å—
â”œâ”€â”€ task-queue.ts           # ä¼˜å…ˆçº§é˜Ÿåˆ—
â”œâ”€â”€ download-worker.ts      # ä¸‹è½½å·¥ä½œå™¨
â”œâ”€â”€ chunk-manager.ts        # åˆ‡ç‰‡ç®¡ç†
â”œâ”€â”€ database-service.ts     # æ•°æ®åº“æœåŠ¡
â””â”€â”€ network-monitor.ts      # ç½‘ç»œç›‘æ§
```

## å››ã€å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€: æ ¸å¿ƒæ¶æ„ (3-4å¤©)
- åˆ›å»º DownloadCenter ä¸»æ¨¡å—
- å®ç° TaskQueue ä¼˜å…ˆçº§é˜Ÿåˆ—
- è®¾è®¡æ•°æ®åº“ Schema
- å®ç°åŸºç¡€ IPC é€šé“

### é˜¶æ®µäºŒ: ä¸‹è½½å¼•æ“ (4-5å¤©)
- å®ç° DownloadWorker å¹¶å‘ä¸‹è½½
- å®ç° ChunkManager åˆ‡ç‰‡ç®¡ç†
- å®ç°æ–­ç‚¹ç»­ä¼ é€»è¾‘
- æ·»åŠ æ–‡ä»¶æ ¡éªŒåŠŸèƒ½

### é˜¶æ®µä¸‰: æ™ºèƒ½è°ƒåº¦ (2-3å¤©)
- å®ç°ä¼˜å…ˆçº§è®¡ç®—
- å®ç°å¹¶å‘è‡ªåŠ¨è°ƒæ•´
- å®ç°ç½‘ç»œç›‘æ§

### é˜¶æ®µå››: ç”¨æˆ·ç•Œé¢ (3-4å¤©)
- å®ç°ä¸‹è½½ä¸­å¿ƒä¸»ç•Œé¢
- å®ç°ä»»åŠ¡ç»„ä»¶
- æ·»åŠ è®¾ç½®é¡µé¢
- å®ç° i18n

**æ€»å·¥æœŸ**: çº¦ 12-16 å¤©

## äº”ã€éªŒæ”¶æ ‡å‡†

- ä¸‹è½½æˆåŠŸç‡ â‰¥ 95%
- æ–­ç‚¹ç»­ä¼ æˆåŠŸç‡ â‰¥ 90%
- å¹³å‡ä¸‹è½½é€Ÿåº¦ â‰¥ 80% å¸¦å®½åˆ©ç”¨ç‡
- ç”¨æˆ·æ»¡æ„åº¦ â‰¥ 85%

## å…­ã€é£é™©ä¸ç¼“è§£

### é£é™©è¯†åˆ«
1. **ç£ç›˜ç©ºé—´ä¸è¶³** - ç¼“è§£: ä¸‹è½½å‰æ£€æŸ¥ç©ºé—´
2. **ç½‘ç»œä¸ç¨³å®š** - ç¼“è§£: æ™ºèƒ½é‡è¯•æœºåˆ¶
3. **å¹¶å‘è¿‡å¤š** - ç¼“è§£: åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°

### å®‰å…¨è€ƒè™‘
- SHA256 æ–‡ä»¶æ ¡éªŒ
- æƒé™æ§åˆ¶ (é˜²æ­¢è·¯å¾„éå†)
- å¼ºåˆ¶ HTTPS (å¯é…ç½®ä¾‹å¤–)
- ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨æ¸…ç†
