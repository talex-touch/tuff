# 搜索使用数据清理计划

## 1. 问题背景

在当前的 Tuff 搜索引擎实现中，系统会为每次搜索和执行操作创建详细的使用记录。这些记录存储在 `usageLogs` 表中，包括：

- 搜索操作记录（action = "search"）
- 执行操作记录（action = "execute"）

随着用户使用频率的增加，`usageLogs` 表中的记录会快速增长，可能导致以下问题：

1. 数据库文件体积不断增大，占用更多磁盘空间
2. 查询性能可能下降，特别是在需要分析历史数据时
3. 备份和恢复操作耗时增加

## 2. 解决方案概述

为了解决上述问题，我们设计了一套数据清理策略，在保留足够历史数据用于分析的同时，控制数据量的增长。

### 2.1 数据保留策略

- 保留最近30天的详细搜索日志（`usageLogs`表）
- `usageSummary`表保留所有数据（聚合统计信息，数据量相对较小）
- 超过30天的详细日志可以被清理

### 2.2 定时清理机制

- 应用启动时执行一次清理任务
- 每天凌晨2点执行定期清理任务
- 清理操作在后台异步执行，不影响用户体验

### 2.3 配置选项

- 在应用设置中添加"数据保留天数"选项：
  - 7天
  - 30天（默认）
  - 90天
  - 永久保留
- 提供手动清理按钮

### 2.4 性能优化

- 为`usageLogs`表的`timestamp`字段添加索引
- 使用批量删除操作，减少数据库操作次数

## 3. 实施计划

### 3.1 数据库层面实现

1. 在 `db/utils.ts` 中添加清理过期使用日志的方法：

   ```typescript
   async clearExpiredUsageLogs(expirationDate: Date) {
     return db.delete(schema.usageLogs).where(lt(schema.usageLogs.timestamp, expirationDate))
   }
   ```

2. 为 `usageLogs` 表的 `timestamp` 字段添加索引以提高查询效率

### 3.2 应用层面实现

1. 创建数据清理服务，负责执行清理任务
2. 实现定时调度机制：
   - 应用启动时触发清理
   - 每天凌晨2点执行定期清理
3. 添加配置管理，允许用户自定义数据保留策略

### 3.3 用户界面

1. 在设置页面添加数据保留配置选项
2. 提供手动清理按钮和清理状态显示

## 4. 测试计划

### 4.1 功能测试

1. 验证清理功能是否能正确删除过期记录
2. 验证保留策略是否按预期工作
3. 验证配置选项是否生效

### 4.2 性能测试

1. 测试清理操作对应用性能的影响
2. 验证大量数据清理时的效率

### 4.3 边界测试

1. 测试无数据可清理的情况
2. 测试清理过程中应用关闭的情况

## 5. 风险评估与缓解措施

### 5.1 数据丢失风险

- 风险：清理操作可能误删重要数据
- 缓解：在删除前进行二次确认，提供日志记录

### 5.2 性能影响风险

- 风险：清理大量数据时可能影响应用性能
- 缓解：采用分批删除策略，限制每次删除的记录数

### 5.3 用户体验风险

- 风险：清理操作可能在用户使用时执行
- 缓解：选择在低峰时段执行清理，提供手动控制选项

## 6. 后续优化建议

1. 实现数据归档功能，将历史数据移动到单独的存储中
2. 添加清理进度显示和状态通知
3. 提供更细粒度的数据保留策略（按操作类型等）
