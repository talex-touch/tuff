# Cloud Sync SDK

## 目的
为 Nexus Sync V1 提供客户端能力，覆盖握手、推送/拉取、blob 上传、配额与密钥管理，并自动处理 sync_token。

## 安装
```ts
import { CloudSyncSDK, useCloudSyncSDK } from '@talex-touch/utils/plugin/sdk'
```

Node/Electron 主进程或自定义认证场景：
```ts
import { CloudSyncSDK } from '@talex-touch/utils'
```

## 插件快速上手（无需手动处理 token）
```ts
const sdk = useCloudSyncSDK()

await sdk.push(items)
const pulled = await sdk.pull({ cursor: 0, limit: 100 })
```

## Renderer/Node（自定义认证）
```ts
const sdk = new CloudSyncSDK({
  baseUrl: 'https://api.example.com',
  getAuthToken: async () => authToken,
  getDeviceId: async () => deviceId,
  fetch,
  formDataFactory: () => new FormData(),
})

await sdk.push(items)
```

## 端到端示例
```ts
const sdk = useCloudSyncSDK()

const handshake = await sdk.handshake()

await sdk.push([
  {
    item_id: 'note-1',
    type: 'note',
    schema_version: 1,
    payload_enc: 'ciphertext',
    payload_ref: null,
    meta_plain: { title: 'Hello' },
    payload_size: 128,
    updated_at: new Date().toISOString(),
    op_seq: 1,
    op_hash: 'hash-1',
    op_type: 'upsert',
  },
])

const pulled = await sdk.pull({ cursor: handshake.server_cursor, limit: 100 })

const blob = new Blob(['hello'], { type: 'text/plain' })
const upload = await sdk.uploadBlob(blob, { filename: 'note.txt' })

const quotas = await sdk.getQuotas()
```

## 错误处理示例
```ts
import { CloudSyncError } from '@talex-touch/utils/plugin/sdk'

try {
  await sdk.push(items)
} catch (error) {
  if (error instanceof CloudSyncError) {
    console.log(error.status, error.errorCode)
  }
}
```

## 注意事项
- 需要 Bearer 认证与 `x-device-id`。
- `sync_token` 自动管理，并通过 `x-sync-token` 传递。
- Node/Electron 主进程需要自行注入 `fetch` 与 `formDataFactory`。
- 插件 SDK 默认通过 AccountSDK 获取 auth token 与 device id（`account:get-auth-token` / `account:get-device-id`）。
- Prelude 中需要先调用 `accountSDK.setChannelSend(send)` 或在 CloudSyncSDK options 传入 `channelSend`。
